<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="assets/css/custom/common.css" rel="stylesheet" type="text/css">
    <link href="assets/css/bootstrap/bootstrap.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="../css/bootstrap-select.min.css">
    <script src="assets/js/jquery-1.12.3/jquery.js"></script>
    <script src="assets/js/d3/d3.v3.js"></script>
    <script src="assets/js/bootstrap/bootstrap.js"></script>
    <script src="../js/bootstrap-select.js"></script>
    <script src="../js/defaults-zh_CN.min.js"></script>
    <script src="assets/js/jquery-nicescroll/jquery.nicescroll.js"></script>
    <script src="../plugins/layer/layer.js"></script>
    <script src="../js/html5media.js"></script>
    <script src="../js/function.js"></script>
    <script src="../js/basic.js"></script>
    <script src="../js/vue.js"></script>
    <script src="../js/FileSaver.min.js"></script>
    <script src="../js/jquery.wordexport.js"></script>
    <!--<script src="../js/jquery.PrintArea.js"></script>-->
    <script src="../js/bootstrap-paginator.min.js"></script>
    <script src="../js/jquery-migrate-1.2.1.min.js"></script>
    <script src="../js/jquery.jqprint-0.3.js"></script>
    <script src="../js/jquery.cookies.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/jquery.tmpl.min.js" type="text/javascript"></script>
    <style>
        .slide{
            left: -20px;
        }
    </style>
</head>
<body>
<div class="ks_head">
    <div class="ks_container">
        <div class="ks_user">
            <div class="ks_photo">
                <img src="assets/img/main/photo.png">
            </div>
            <div class="ks_name">@Administrators</div>
        </div>
        <div class="ks_menu ks_menu_left">
            <a class="ks_menu_item dituHref" target="_self">
                <img src="assets/img/main/icon_01.png">
                <div class="ks_menu_title">地图</div>
            </a>
            <a class="ks_menu_item relationHref" target="_self">
                <img src="assets/img/main/icon_02.png">
                <div class="ks_menu_title">关系网络</div>
            </a>
            <a class="ks_menu_item" href="#">
                <img src="assets/img/main/icon_03.png">
                <div class="ks_menu_title">翻译</div>
            </a>
            <a class="ks_menu_item" href="#">
                <img src="assets/img/main/icon_04.png">
                <div class="ks_menu_title">图谱管理</div>
            </a>
        </div>
        <div class="ks_search">
            <input type="text">
            <span class="glyphicon glyphicon-search"></span>
        </div>
        <div class="ks_menu ks_menu_right">
            <a class="ks_menu_item" href="#">
                <img src="assets/img/main/icon_05.png">
                <div class="ks_menu_title">收藏</div>
            </a>
            <a class="ks_menu_item wordprint" href="#">
                <img src="assets/img/main/icon_06.png">
                <div class="ks_menu_title">打印</div>
            </a>
            <a class="ks_menu_item worddao" href="#">
                <img src="assets/img/main/icon_07.png">
                <div class="ks_menu_title">导出</div>
            </a>
            <a class="ks_menu_item" href="../main.html" target="_self" >
                <img src="assets/img/main/icon_08.png">
                <div class="ks_menu_title">返回地球</div>
            </a>
            <a class="ks_menu_item returnCountry">
                <img src="assets/img/main/icon_09.png">
                <div class="ks_menu_title">返回国家</div>
            </a>
        </div>
    </div>
</div>
<div class="ks_main" id="ks_main" style="position: relative; padding: 0;" >

    <form class="form-inline" style="margin-top: 20px; margin-left: 20px;">
        <div class="form-group">
            <label for="startNode">开始节点：</label>
            <input type="text" class="form-control intelligentInput" id="startNode">
        </div>
        <div class="form-group">
            <label for="endNode">结束节点：</label>
            <input type="text" class="form-control intelligentInput" id="endNode" >
        </div>
        <div class="form-group" id="startNodes">

        </div>

        <div class="form-group" id="endNodes">

        </div>
        <div class="form-group" id="relations">

        </div>
        <div class="form-group">
            <label for="interNumber">网络跳数：</label>
            <input type="text" class="form-control intelligentInput" id="interNumber"  style="width: 80px">
        </div>
        <div class="form-group">
            <label for="maxNumber">最大条数：</label>
            <input type="text" class="form-control intelligentInput" id="maxNumber" style="width: 80px" >
        </div>
        <div class="form-group">
            <label for="beeline">最短距离：</label>
            <input type="text" class="form-control intelligentInput" id="beeline" style="width: 80px">
        </div>
        <button id="relationSearch" type="button" class="btn btn-default">开始查询</button>
    </form>

    <svg class="ks_relation">
    </svg>
</div>
<div class="slide">
    <span> <img src="assets/img/main/hide.png" alt="收缩"> </span>
</div>

</body>
</html>

<script>
    $(".returnCountry").attr("href","../pages/countryOverview.html?EntityID=" +$.cookie("CountryEntityID")+ "&type=" + $.cookie("CountryType") );
    $(".dituHref").attr("href",  "main_earths.html?EntityID=" +$.cookie("CountryEntityID")+ "&type=" + $.cookie("CountryType")   );
    $(".relationHref").attr("href",  "main_relation.html?EntityID=" +$.cookie("CountryEntityID")+ "&type=" + $.cookie("CountryType")   );
    $(".worddao").on("click",function(e){
        e.preventDefault();
        $("body").wordExport();
    });
    $(".wordprint").on("click",function(e){
        e.preventDefault();
        $("body").jqprint();
    });


    $.ajax({
        "type": "get",
        "url": HOST,
        "data":{
            method : "getRelType"
        },
        "success": function (response, status, xhr) {
            var result = $(response).text();
            console.log(result);
            var resultData = JSON.parse(result);

            $("#relations").html('<label for="relationNodeType">关系：</label><select class="selectpicker show-tick form-control" id="relationNodeType" data-width="100" data-size="7" ></select>');

            for(var i = 0 ; i < resultData.length; i ++){
                $("#relationNodeType").append("<option value='" + resultData[i].value + "'>"+ resultData[i].name  +"</option>");

            }
            $('#relationNodeType').selectpicker();
        },
        "error": function (xhr, errorText, errorStatus) {  //访问错误后的回调函数  第一个参数对象 第二个错误的文本 第三个错误的类型
            alert("ajax访问错误:" + xhr.status + " " + xhr.statusText);        //错误的编号 和文本
        }

    });

    $.ajax({
        "type": "get",
        "url": HOST,
        "data":{
            method : "getNodeType"
        },
        "success": function (response, status, xhr) {
            var result = $(response).text();
            console.log(result);
            var resultData = JSON.parse(result);



            $("#startNodes").html('<label for="startNodeType">开始节点类型：</label><select class="selectpicker show-tick form-control" id="startNodeType" data-width="100" data-size="7" ></select>');
            $("#endNodes").html('<label for="endNodeType">结束节点类型：</label><select class="selectpicker show-tick form-control" id="endNodeType" data-width="100" data-size="7" ></select>');
            for(var i = 0 ; i < resultData.length; i ++){
                $("#startNodeType").append("<option value='" + resultData[i].value + "'>"+ resultData[i].name  +"</option>");
                $("#endNodeType").append("<option value='" + resultData[i].value + "'>"+ resultData[i].name  +"</option>");
            }
            $('#startNodeType,#endNodeType').selectpicker();


        },
        "error": function (xhr, errorText, errorStatus) {  //访问错误后的回调函数  第一个参数对象 第二个错误的文本 第三个错误的类型
            alert("ajax访问错误:" + xhr.status + " " + xhr.statusText);        //错误的编号 和文本
        }

    });

    $("#relationSearch").on("click",function(){
                $.ajax({
                    "type": "get",
                    "url": HOST,
                    "data":{
                        method : "getAutoSearch",
                        n1 : $("#startNode").val(),
                        n2 : $("#endNode").val(),
                        node1Type : $('#startNodeType').selectpicker("val"),
                        node2Type :  $('#endNodeType').selectpicker("val"),
                        rel :  $('#relationNodeType').selectpicker("val"),
                        wlts : $("#interNumber").val(),
                        zdts : $("#maxNumber").val(),
                        zdlj : $("#beeline").val()
                    },
                    "success": function (response, status, xhr) {
                        var result = $(response).text();
                        var resultData = JSON.parse(result);
                        var root = resultData.graph;
                        console.log(resultData.table);

                        $.ajax({
                            "type": "get",
                            "url": "layer_relationContent.html",
                            "success": function (response, status, xhr) {
                                var height = $(window).height() - 45;
                                var width = $(window).width() / 5;
                                layer.open({
                                    type: 1,
                                    title: false,
                                    closeBtn: 0,
                                    skin: "layui-layer-relation", //添加类名
                                    area: [width + "px", height - 175 + "px"],
                                    offset: ['195px', '0px'],
                                    shadeClose: false,
                                    shade: 0,
                                    content: response,
                                    success: function (layero, index) {
                                        $(".slide").css({
                                            'left': width + "px",
                                            'top': $(".layui-layer.layui-layer-relation").height() / 2 + $(".slide").height() / 2  + "px",
                                            'border' : '1px solid #d9d9d9'
                                        });

                                        $(".slide").on("click",function(){
                                            if($(this).css("left") !== "0px" ){
                                                $(".layui-layer.layui-layer-relation").animate({
                                                    left : - $(".layui-layer.layui-layer-relation").width() + "px"
                                                },500);
                                                $(this).animate({
                                                    left : 0
                                                },500)
                                            }else {
                                                $(".layui-layer.layui-layer-relation").animate({
                                                    left : 0
                                                },500);
                                                $(this).animate({
                                                    left :  $(".layui-layer.layui-layer-relation").width() + "px"
                                                },500)
                                            }
                                        });
                                        $(".layui-layer-page .layui-layer-content").niceScroll({
                                            styler: "fb",
                                            cursorcolor: "#959595",
                                            cursorwidth: '6',
                                            cursorborderradius: '15px',
                                            background: '#eee',
                                            cursorborder: '',
                                            zindex: 5
                                            //        autohidemode: false //是否开启不隐藏滚动条
                                        });
                                        $(".ks_relation").html("");
                                        var draw = function () {
                                            var width = $(window).width() - 20;
                                            var height = $(window).height() - 190;
                                            var svg = d3.select("svg")
                                                    .attr("width", width)
                                                    .attr("height", height);
                                            var force = d3.layout.force()
                                                    .nodes(root.nodes)
                                                    .links(root.edges)
                                                    .size([width, height])
                                                    .linkDistance(200)
                                                    .charge(-1500)
                                                    .start();

                                            var edges_line = svg.selectAll("line")
                                                    .data(root.edges)
                                                    .enter()
                                                    .append("line")
                                                    .style("cursor", "pointer")
                                                    .style("stroke", "#337ab7")
                                                    .style("stroke-width", 4)
                                                    .on("click", function (d, i) {
                                                        console.log(d);
                                                        $(".layer-content .tab-content.selected").html('');
                                                        $(".layui-layer-relation .tab ul li").removeClass('active');
                                                        $(".layui-layer-relation .tab ul li.tab-select").addClass('active');
                                                        $(".layer-content .tab-content.list").hide();
                                                        $(".layer-content .tab-content.selected").show();
                                                        //显示连接线上的文字
                                                        var sourceVal = "";
                                                        var targetVal = "";
                                                        for (var i in d.source) {
                                                            sourceVal += "<tr><td>" + i + "</td><td>" + d.source[i] + "</td></tr>";
                                                        }
                                                        for (var k in d.target) {
                                                            targetVal += "<tr><td>" + k + "</td><td>" + d.target[k] + "</td></tr>";
                                                        }
                                                        $(".layer-content .tab-content.selected").html("<div class='correlation'>\
                            <div class='col-xs-3'>关联</div>\
                                    <div class='col-xs-9'>\
                                    <button class='btn btn-default'>" + d.source.name + "</button>\
                                    <button class='btn btn-default'>" + d.target.name + "</button>\
                                    </div>\
                                    </div>\
                                    <div class='correlation-table main-table'>\
                                    <h1>全部关系</h1>\
                                    <table class='table table-bordered'>\
                                    <thead>\
                                    <tr>\
                                    <th>起点</th>\
                                    <th>终点</th>\
                                    <th>关系</th>\
                                    <th>文档</th>\
                                    </tr>\
                                    </thead>\
                                    <tbody>\
                                    <tr>\
                                    <td>" + d.source.name + "</td>\
                                    <td>" + d.target.name + "</td>\
                                    <td>" + d.relation + "</td>\
                                    <td>" + d.source.document + "</td>\
                                    </tr>\
                                    <tr>\
                                     <td>" + d.target.name + "</td>\
                                    <td>" + d.source.name + "</td>\
                                    <td>" + d.relation + "</td>\
                                    <td>" + d.target.document + "</td>\
                                    </tr>\
                                    </tbody>\
                                    </table>\
                                    </div><div class='correlation-table'><h1>" + d.source.name + "</h1>\
                                    <table class='table table-bordered'>\
                                    <thead>\
                                    <tr>\
                                    <th>属性</th>\
                                    <th>值</th>\
                                    </tr>\
                                    </thead>\
                                    <tbody>" + sourceVal + "</tbody>\
                                    </table></div>\
                                    <div class='correlation-table'><h1>" + d.target.name + "</h1>\
                                    <table class='table table-bordered'>\
                                    <thead>\
                                    <tr>\
                                    <th>属性</th>\
                                    <th>值</th>\
                                    </tr>\
                                    </thead>\
                                    <tbody>" + targetVal + "</tbody>\
                                    </table></div>");
                                                    });

                                            var edges_text = svg.selectAll(".linetext")
                                                    .data(root.edges)
                                                    .enter()
                                                    .append("text")
                                                    .attr("class", "linetext")
                                                    .text(function (d) {
                                                        return d.relation;
                                                    });


                                            //定义一个线性渐变
                                            var defs = svg.append("defs");

                                            var linearGradient = defs.append("linearGradient")
                                                    .attr("id", "linearColor")
                                                    .attr("x1", "0%")
                                                    .attr("y1", "0%")
                                                    .attr("x2", "0%")
                                                    .attr("y2", "100%");

                                            var a = d3.rgb(65, 155, 232);
                                            var b = d3.rgb(51, 122, 183);
                                            var stop1 = linearGradient.append("stop")
                                                    .attr("offset", "0%")
                                                    .style("stop-color", a.toString());

                                            var stop2 = linearGradient.append("stop")
                                                    .attr("offset", "100%")
                                                    .style("stop-color", b.toString());
                                            //线性渐变结束

                                            var nodes_circle = svg.selectAll("circle") //节点的图片
                                                    .data(root.nodes)
                                                    .enter()
                                                    .append("circle")
                                                    .style("cursor", "pointer")
                                                    .attr("r",50)      //半径
                                                    .attr("class","circle") //类 控制样
                                                    .on("mouseover", function (d, i) {
                                                        //显示连接线上的文字
                                                        edges_text.style("fill-opacity", function (edge) {
                                                            if (edge.source === d || edge.target === d) {
                                                                return 1.0;
                                                            }
                                                        });
                                                    })
                                                    .on("mouseout", function (d, i) {
                                                        //隐去连接线上的文字
                                                        edges_text.style("fill-opacity", function (edge) {
                                                            if (edge.source === d || edge.target === d) {
                                                                return 0.0;
                                                            }
                                                        });
                                                    })
                                                    .on("mousedown", function (d, i) {

                                                        var mouseflag =true;

                                                        $(document).one("mousemove",function(e){
                                                            mouseflag = false;
                                                        });

                                                        $(document).one("mouseup",function(e){
                                                            if(mouseflag === true ){
                                                                $(layero).find(".layer-content .tab-content.selected").html('\   <div class="correlation">\
                                                  <div class="col-xs-3"><img src="' + d.image + '" ></div>\
                                                  <div class="col-xs-9"><h1> 节点名称：' + d.name + '</h1><p>节点类型：' + d.nodeType + '</p></div>\
                                              </div>\
                                              <div class="correlation-table attrtable">\
                                                <table class="table table-bordered">\
                                                <thead>\
                                                <tr>\
                                                <th>属性</th>\
                                                <th>值</th>\
                                                </tr>\
                                                </thead>\
                                                <tbody>\
                                                </tbody>\
                                                </table></div>\
                                                        <div class="correlation-table select-table">\
                                                    <h1>多媒体</h1>\
                                                    <div class="panel panel-default">\
                                                    <div class="panel-body">\
                                                    </div>\
                                                    </div>\
                                                    </div>\
                                              <div class="correlation">\
                                                  <div class="col-xs-3">关联</div>\
                                                  <div class="col-xs-9 gx"></div>\
                                              </div>\
                                              <div class="correlation-table main-table">\
                                                    <h1>全部关系</h1>\
                                                    <table class="table table-bordered">\
                                                    <thead>\
                                                    <tr>\
                                                    <th>起点</th>\
                                                    <th>终点</th>\
                                                    <th>关系</th>\
                                                    <th>关联文档</th>\
                                                    </tr>\
                                                    </thead>\
                                                    <tbody>\
                                                    </tbody>\
                                                    </table>\
                                                    </div>');
                                                                $(".layui-layer-relation .tab ul li").removeClass('active');
                                                                $(".layui-layer-relation .tab ul li.tab-select").addClass('active');
                                                                $(".layer-content .tab-content.list").hide();
                                                                $(".layer-content .tab-content.selected").show();
                                                                var targetArray = [];
                                                                var sourceArray = [];
                                                                for (var bl = 0; bl < root.edges.length; bl++) {
                                                                    if (d.index == root.edges[bl].source.index) {
                                                                        targetArray.push({
                                                                            name: root.edges[bl].target.name,
                                                                            document: root.edges[bl].target.document,
                                                                            relation: root.edges[bl].relation
                                                                        });
                                                                    } else if (d.index == root.edges[bl].target.index) {
                                                                        sourceArray.push({
                                                                            name: root.edges[bl].source.name,
                                                                            document: root.edges[bl].source.document,
                                                                            relation: root.edges[bl].relation
                                                                        });
                                                                    }
                                                                }

                                                                $(".layer-content").find(".correlation").find(".col-xs-9.gx").html('').append("<button class='btn btn-default' style='color:red;'>" + d.name + "</button>");
                                                                for (var tl = 0; tl < targetArray.length; tl++) {
                                                                    $(".layer-content").find(".correlation").find(".col-xs-9.gx").append("<button class='btn btn-default'>" + targetArray[tl].name + "</button>");
                                                                    $(".layer-content").find(".main-table").find("tbody").append("<tr><td style='color:red;'>" + d.name + "</td><td>" + targetArray[tl].name + "</td><td>" + targetArray[tl].relation + "</td><td>" + targetArray[tl].document + "</td></tr>");
                                                                }
                                                                for (var al = 0; al < sourceArray.length; al++) {
                                                                    $(".layer-content").find(".correlation").find(".col-xs-9.gx").append("<button class='btn btn-default'>" + sourceArray[al].name + "</button>");
                                                                    $(".layer-content").find(".main-table").find("tbody").append("<tr><td>" + sourceArray[al].name + "</td><td style='color:red;'>" + d.name + "</td><td>" + sourceArray[al].relation + "</td><td>" + sourceArray[al].document + "</td></tr>");
                                                                }

                                                                for(var attrtableL in d ){
                                                                    if(attrtableL == "name" || attrtableL == "document" || attrtableL == "image" || attrtableL == "type" || attrtableL == "nodeType" ) {
                                                                        $(".attrtable").find("table").find("tbody").append("<tr><td>" + attrtableL + "</td><td>" + d[attrtableL] + "</td></tr>");
                                                                    }
                                                                }
                                                                if(d.video.length == 0){
                                                                    $(".select-table").find(".panel-body").append("<p>暂无视频</p>");
                                                                }else{
                                                                    for(var videoL = 0;videoL < d.video.length;videoL ++ ){
                                                                        $(".select-table").find(".panel-body").append("<video width='100%' height='240' controls>\
                                                    <source src='"+d.video[videoL] +"' type='video/mp4'>\
                                                     </video>");
                                                                    }
                                                                }



                                                            }
                                                        });





                                                    })
                                                    .style("fill", "url(#" + linearGradient.attr("id") + ")")
                                                    .call(force.drag);



                                            var nodes_text = svg.selectAll(".nodetext")
                                                    .data(root.nodes)
                                                    .enter()
                                                    .append("text")
                                                    .attr("class", "nodetext")
                                                    .on("mouseover", function (d, i) {
                                                        //显示连接线上的文字
                                                        edges_text.style("fill-opacity", function (edge) {
                                                            if (edge.source === d || edge.target === d) {
                                                                return 1.0;
                                                            }
                                                        });
                                                    })
                                                    .on("mouseout", function (d, i) {
                                                        //隐去连接线上的文字
                                                        edges_text.style("fill-opacity", function (edge) {
                                                            if (edge.source === d || edge.target === d) {
                                                                return 0.0;
                                                            }
                                                        });
                                                    })
                                                    .on("mousedown", function (d, i) {

                                                        var mouseflag =true;

                                                        $(document).one("mousemove",function(e){
                                                            mouseflag = false;
                                                        });

                                                        $(document).one("mouseup",function(e){
                                                            if(mouseflag === true ){
                                                                $(layero).find(".layer-content .tab-content.selected").html('\   <div class="correlation">\
                                                  <div class="col-xs-3"><img src="' + d.image + '" ></div>\
                                                  <div class="col-xs-9"><h1> 节点名称：' + d.name + '</h1><p>节点类型：' + d.nodeType + '</p></div>\
                                              </div>\
                                              <div class="correlation-table attrtable">\
                                                <table class="table table-bordered">\
                                                <thead>\
                                                <tr>\
                                                <th>属性</th>\
                                                <th>值</th>\
                                                </tr>\
                                                </thead>\
                                                <tbody>\
                                                </tbody>\
                                                </table></div>\
                                                        <div class="correlation-table select-table">\
                                                    <h1>多媒体</h1>\
                                                    <div class="panel panel-default">\
                                                    <div class="panel-body">\
                                                    </div>\
                                                    </div>\
                                                    </div>\
                                              <div class="correlation">\
                                                  <div class="col-xs-3">关联</div>\
                                                  <div class="col-xs-9 gx"></div>\
                                              </div>\
                                              <div class="correlation-table main-table">\
                                                    <h1>全部关系</h1>\
                                                    <table class="table table-bordered">\
                                                    <thead>\
                                                    <tr>\
                                                    <th>起点</th>\
                                                    <th>终点</th>\
                                                    <th>关系</th>\
                                                    <th>关联文档</th>\
                                                    </tr>\
                                                    </thead>\
                                                    <tbody>\
                                                    </tbody>\
                                                    </table>\
                                                    </div>');
                                                                $(".layui-layer-relation .tab ul li").removeClass('active');
                                                                $(".layui-layer-relation .tab ul li.tab-select").addClass('active');
                                                                $(".layer-content .tab-content.list").hide();
                                                                $(".layer-content .tab-content.selected").show();
                                                                var targetArray = [];
                                                                var sourceArray = [];
                                                                for (var bl = 0; bl < root.edges.length; bl++) {
                                                                    if (d.index == root.edges[bl].source.index) {
                                                                        targetArray.push({
                                                                            name: root.edges[bl].target.name,
                                                                            document: root.edges[bl].target.document,
                                                                            relation: root.edges[bl].relation
                                                                        });
                                                                    } else if (d.index == root.edges[bl].target.index) {
                                                                        sourceArray.push({
                                                                            name: root.edges[bl].source.name,
                                                                            document: root.edges[bl].source.document,
                                                                            relation: root.edges[bl].relation
                                                                        });
                                                                    }
                                                                }

                                                                $(".layer-content").find(".correlation").find(".col-xs-9.gx").html('').append("<button class='btn btn-default' style='color:red;'>" + d.name + "</button>");
                                                                for (var tl = 0; tl < targetArray.length; tl++) {
                                                                    $(".layer-content").find(".correlation").find(".col-xs-9.gx").append("<button class='btn btn-default'>" + targetArray[tl].name + "</button>");
                                                                    $(".layer-content").find(".main-table").find("tbody").append("<tr><td style='color:red;'>" + d.name + "</td><td>" + targetArray[tl].name + "</td><td>" + targetArray[tl].relation + "</td><td>" + targetArray[tl].document + "</td></tr>");
                                                                }
                                                                for (var al = 0; al < sourceArray.length; al++) {
                                                                    $(".layer-content").find(".correlation").find(".col-xs-9.gx").append("<button class='btn btn-default'>" + sourceArray[al].name + "</button>");
                                                                    $(".layer-content").find(".main-table").find("tbody").append("<tr><td>" + sourceArray[al].name + "</td><td style='color:red;'>" + d.name + "</td><td>" + sourceArray[al].relation + "</td><td>" + sourceArray[al].document + "</td></tr>");
                                                                }

                                                                for(var attrtableL in d ){
                                                                    if(attrtableL == "name" || attrtableL == "document" || attrtableL == "image" || attrtableL == "type" || attrtableL == "nodeType" ) {
                                                                        $(".attrtable").find("table").find("tbody").append("<tr><td>" + attrtableL + "</td><td>" + d[attrtableL] + "</td></tr>");
                                                                    }
                                                                }
                                                                if(d.video.length == 0){
                                                                    $(".select-table").find(".panel-body").append("<p>暂无视频</p>");
                                                                }else{
                                                                    for(var videoL = 0;videoL < d.video.length;videoL ++ ){
                                                                        $(".select-table").find(".panel-body").append("<video width='100%' height='240' controls>\
                                                    <source src='"+d.video[videoL] +"' type='video/mp4'>\
                                                     </video>");
                                                                    }
                                                                }



                                                            }
                                                        });





                                                    })
                                                    .text(function (d) {
                                                        if(d.name.length > 4 ){
                                                            return d.name.substring(0,4) + "..";
                                                        }else{
                                                            return d.name;
                                                        }
                                                    })
                                                    .call(force.drag);





                                            force.on("tick", function () {

                                                root.nodes.forEach(function (d, i) {
                                                    d.x = d.x - 50 < 0 ? 50 : d.x;
                                                    d.y = d.y - 50 < 0 ? 50 : d.y;
                                                });

                                                //更新连接线的位置
                                                edges_line.attr("x1", function (d) {
                                                    return d.source.x;
                                                });
                                                edges_line.attr("y1", function (d) {
                                                    return d.source.y;
                                                });
                                                edges_line.attr("x2", function (d) {
                                                    return d.target.x;
                                                });
                                                edges_line.attr("y2", function (d) {
                                                    return d.target.y;
                                                });

                                                //更新连接线上文字的位置
                                                edges_text.attr("x", function (d) {
                                                    return (d.source.x + d.target.x) / 2;
                                                });

                                                edges_text.attr("y", function (d) {
                                                    return (d.source.y + d.target.y) / 2;
                                                });

                                                nodes_circle.attr("cx", function (d) {
                                                    return d.x;
                                                });
                                                nodes_circle.attr("cy", function (d) {
                                                    return d.y
                                                });
                                                nodes_text.attr("x", function (d) {
                                                    return d.x - nodes_circle.attr("r") + 15;
                                                });
                                                nodes_text.attr("y", function (d) {
                                                    return d.y + 5;
                                                });
                                            });
                                            return svg;
                                        };
                                        var svg = draw();


                                    }
                                });

                            },
                            "error": function (xhr, errorText, errorStatus) {  //访问错误后的回调函数  第一个参数对象 第二个错误的文本 第三个错误的类型
                                alert("ajax访问错误:" + xhr.status + " " + xhr.statusText);        //错误的编号 和文本
                            }
                        });
                        layer.open({

                        });




                    },
                    "error": function (xhr, errorText, errorStatus) {  //访问错误后的回调函数  第一个参数对象 第二个错误的文本 第三个错误的类型
                        alert("ajax访问错误:" + xhr.status + " " + xhr.statusText);        //错误的编号 和文本
                    }
                });


    });

    $(".ks_head .ks_search span.glyphicon").on("click",function(){
        var keyword = $(".ks_head .ks_search").find("input").val();
        $.ajax({
            type: "get",  //访问WebService使用get方式请求
            url: HOST, //调用WebService的地址和方法名称组合
            data: {
                method: "getAutoCart",
                keyword:encodeURI(keyword)
            },
            success: function (data) {
                var result = $(data).text();
                var resultData = JSON.parse(result);
                console.log(resultData);

                var width = $(window).width() / 1.5;
                var height = $(window).height() / 1.5;
                $.ajax({
                    "type": "get",
                    "url": "layer_autoCard.html",
                    "success": function (response, status, xhr) {
                        layer.open({
                            type: 1,
                            title: "自动卡片",
                            skin: "layui-layer-lbf", //添加类名
                            closeBtn: 1,
                            area: [width + "px", height + "px"],
                            shadeClose: true,
                            content: response,
                            success: function (layero,index) {
                                for (var i=0;i < resultData.length;i++){
                                    $(layero).find(".autoCard").append('<div class="col-xs-3 card-xs">\
                                                    <div class="nrcard">\
                                                     <h5 class="bg-primary" style="padding: 5px 0; text-indent: 10px;">卡片 — '+ (i+1) +'</h5>\
                                                      <table class="table table-condensed table-bordered table-striped">\
                                                                <tr><th>名称</th><td>'+resultData[i].name+'</td></tr>\
                                                                <tr><th>国家</th><td>'+resultData[i].country+'</td></tr>\
                                                                <tr><th>编号</th><td>'+resultData[i].id+'</td></tr>\
                                                                <tr><th>来源</th><td>'+resultData[i].source+'</td></tr>\
                                                                <tr><th>标签</th><td>'+resultData[i].tag+'</td></tr>\
                                                                <tr><th>类型</th><td>'+resultData[i].type+'</td></tr>\
                                                       </table>\
                                                    </div>\
                                           </div>');
                                }
                            }
                        });
                    }
                });

            },
            "error": function (xhr, errorText, errorStatus) {  //访问错误后的回调函数  第一个参数对象 第二个错误的文本 第三个错误的类型
                alert("ajax访问错误:" + xhr.status + " " + xhr.statusText);        //错误的编号 和文本
            }
        });





    });

</script>